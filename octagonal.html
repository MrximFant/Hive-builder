<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Multi-Map Builder</title>
    <style>
        body {
            display: flex;
            font-family: Arial, sans-serif;
            margin: 0;
            height: 100vh;
            overflow: hidden;
        }

        #sidebar {
            width: 220px;
            background-color: #f0f0f0;
            padding: 15px;
            border-right: 1px solid #ccc;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        #sidebar h3 {
            margin-top: 0;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
            font-size: 1.1em;
        }

        .buildable-item {
            padding: 8px;
            margin-bottom: 10px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: grab;
            text-align: center;
            user-select: none;
            font-size: 0.9em;
        }
        .buildable-item:active {
            cursor: grabbing;
        }
        .buildable-item img {
            max-width: 50px;
            max-height: 50px;
            display: block;
            margin: 0 auto 5px;
            border: 1px solid #eee;
        }

        #main-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #toolbar {
            padding: 10px;
            background-color: #e9ecef;
            border-bottom: 1px solid #ccc;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            font-size: 0.9em;
        }
        #toolbar label, #toolbar span {
            margin-right: 5px;
        }
        #toolbar button {
            padding: 5px 10px;
        }

        #grid-wrapper { /* This now wraps the maps-super-container */
            flex-grow: 1;
            overflow: auto; /* Allows scrolling for all maps together */
            background-color: #d0d0d0; /* Slightly darker background for the wrapper */
            padding: 10px; /* Padding around the group of maps */
        }

        #maps-super-container { /* Container for the 2x3 grid of maps */
            display: flex;
            flex-wrap: wrap;
            gap: 15px; /* Space between individual maps */
            /* justify-content: flex-start; /* Default, can be center if preferred */
            /* min-width will be set by JS to help with scrolling */
        }

        .individual-map-container {
            /* width and height set by JS based on currentTileSize */
            background-image:
                linear-gradient(to right, #ccc 1px, transparent 1px),
                linear-gradient(to bottom, #ccc 1px, transparent 1px);
            /* background-size set by JS */
            position: relative;
            border: 2px solid black; /* Border for each map */
            box-sizing: border-box;
            overflow: hidden; /* Clip items to map bounds */
        }

        .placed-item-on-grid {
            position: absolute;
            border: 1px solid #0056b3;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .placed-item-on-grid img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
        }

        .placed-item-text-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            font-size: clamp(0.6em, 1.5vw, 0.8em); /* Adjusted max slightly */
            padding: 2px 4px;
            box-sizing: border-box;
            text-align: center;
            pointer-events: none;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #alliance-section {
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }
        #alliance-section input[type="text"] {
            width: calc(100% - 75px);
            margin-right: 5px;
            padding: 6px;
            box-sizing: border-box;
        }
        #alliance-section button {
             padding: 6px 10px;
        }
        #alliance-list {
            list-style-type: none;
            padding: 0;
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
            font-size: 0.9em;
        }
        #alliance-list li {
            padding: 6px 8px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #alliance-list li:hover {
            background-color: #e9e9e9;
        }
        #alliance-list li.selected {
            font-weight: bold;
            background-color: #d0e0ff;
        }
        .delete-alliance-btn {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 1.1em;
            padding: 0 5px;
        }
        .delete-alliance-btn:hover {
            color: #c82333;
        }
    </style>
</head>
<body>

    <div id="sidebar">
        <h3>Buildable Items</h3>
        <div id="buildable-items-list">
            <div class="buildable-item" draggable="true"
                 data-item-id="base" data-width="3" data-height="3"
                 data-image-src="images/base.jpg" data-name="Base">
                <img src="images/base.jpg" alt="Base Preview">
                Base (3x3)
            </div>
            <div class="buildable-item" draggable="true"
                 data-item-id="city2" data-width="11" data-height="11"
                 data-image-src="images/city2.jpg" data-name="City">
                <img src="images/city2.jpg" alt="City Preview">
                City (11x11)
            </div>
            <div class="buildable-item" draggable="true"
                 data-item-id="lake" data-width="9" data-height="10"
                 data-image-src="images/lake.jpg" data-name="Lake">
                <img src="images/lake.jpg" alt="Lake Preview">
                Lake (9x10)
            </div>
            <div class="buildable-item" draggable="true"
                 data-item-id="lake_rotated" data-width="10" data-height="9"
                 data-image-src="images/lake.jpg" data-name="Lake (Rotated)">
                <img src="images/lake.jpg" alt="Lake Rotated Preview">
                Lake (10x9)
            </div>
            <div class="buildable-item" draggable="true"
                 data-item-id="mountain" data-width="9" data-height="10"
                 data-image-src="images/mountain.jpg" data-name="Mountain">
                <img src="images/mountain.jpg" alt="Mountain Preview">
                Mountain (9x10)
            </div>
            <div class="buildable-item" draggable="true"
                 data-item-id="mountain_rotated" data-width="10" data-height="9"
                 data-image-src="images/mountain.jpg" data-name="Mountain (Rotated)">
                <img src="images/mountain.jpg" alt="Mountain Rotated Preview">
                Mountain (10x9)
            </div>
            <div class="buildable-item" draggable="true"
                 data-item-id="mountain_lake" data-width="16" data-height="17"
                 data-image-src="images/mountain_lake.jpg" data-name="Mountain Lake">
                <img src="images/mountain_lake.jpg" alt="Mountain Lake Preview">
                Mountain Lake (16x17)
            </div>
            <div class="buildable-item" draggable="true"
                 data-item-id="furnace" data-width="5" data-height="5"
                 data-image-src="images/furnace.jpg" data-name="Furnace">
                <img src="images/furnace.jpg" alt="Furnace Preview">
                Furnace (5x5)
            </div>
            <div class="buildable-item" draggable="true"
                 data-item-id="mg" data-width="3" data-height="3"
                 data-image-src="images/mg.jpg" data-name="MG Unit">
                <img src="images/mg.jpg" alt="MG Unit Preview">
                MG Unit (3x3)
            </div>
        </div>

        <div id="alliance-section">
            <h3>Alliances</h3>
            <div>
                <input type="text" id="new-alliance-name" placeholder="Alliance Name">
                <button id="add-alliance-btn">Add</button>
            </div>
            <ul id="alliance-list"></ul>
        </div>
    </div>

    <div id="main-area">
        <div id="toolbar">
            <label for="tile-size-slider">Zoom:</label>
            <input type="range" id="tile-size-slider" min="5" max="40" value="20" title="Adjust Grid Zoom">
            <span id="tile-size-value">20px</span>
            <span>|</span>
            <span>Grid: <span id="grid-dimensions-display">WxH</span> Tiles</span>
            <span>|</span>
            <button id="clear-all-btn" title="Remove all items from all maps">Clear All</button>
            <span>|</span>
            <span>Selected Alliance: <strong id="current-alliance-display">None</strong></span>
        </div>
        <div id="grid-wrapper">
            <div id="maps-super-container">
                <!-- Individual map containers will be dynamically added here by JS -->
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const TILES_PER_MAP_X = 75;
        const TILES_PER_MAP_Y = 75;
        const NUM_MAPS_ACROSS = 2;
        const NUM_MAPS_DOWN = 3;
        const TOTAL_MAPS = NUM_MAPS_ACROSS * NUM_MAPS_DOWN;

        const SINGLE_MAP_COLS = TILES_PER_MAP_X;
        const SINGLE_MAP_ROWS = TILES_PER_MAP_Y;
        let currentTileSize = 20;

        // --- DOM ELEMENTS ---
        const mapsSuperContainer = document.getElementById('maps-super-container');
        const buildableItemsList = document.querySelectorAll('#buildable-items-list .buildable-item');
        const tileSizeSlider = document.getElementById('tile-size-slider');
        const tileSizeValueDisplay = document.getElementById('tile-size-value');
        const gridDimensionsDisplay = document.getElementById('grid-dimensions-display');
        const clearAllBtn = document.getElementById('clear-all-btn');
        const newAllianceNameInput = document.getElementById('new-alliance-name');
        const addAllianceBtn = document.getElementById('add-alliance-btn');
        const allianceListUl = document.getElementById('alliance-list');
        const currentAllianceDisplay = document.getElementById('current-alliance-display');

        // --- STATE ---
        let draggedItemData = null;
        let placedItems = [];
        let alliances = ["Neutral"];
        let selectedAllianceName = "Neutral";
        let nextPlacedItemId = 0;
        let mapElements = [];

        // --- MAP/GRID FUNCTIONS ---
        function createMapContainers() {
            mapsSuperContainer.innerHTML = '';
            mapElements = [];
            for (let i = 0; i < TOTAL_MAPS; i++) {
                const mapDiv = document.createElement('div');
                mapDiv.classList.add('individual-map-container');
                mapDiv.dataset.mapId = i;
                mapDiv.addEventListener('dragover', handleMapDragOver);
                mapDiv.addEventListener('drop', handleMapDrop);
                mapsSuperContainer.appendChild(mapDiv);
                mapElements.push(mapDiv);
            }
            updateGridAppearance();
        }

        function updateGridAppearance() {
            mapElements.forEach(mapDiv => {
                mapDiv.style.width = `${SINGLE_MAP_COLS * currentTileSize}px`;
                mapDiv.style.height = `${SINGLE_MAP_ROWS * currentTileSize}px`;
                mapDiv.style.backgroundSize = `${currentTileSize}px ${currentTileSize}px`;
            });

            // Calculate the required width for the super container to help with scrolling
            const gapBetweenMaps = 15; // Must match CSS 'gap'
            const mapBorderWidth = 2 * 2; // 2px border on each side for an individual map
            const totalMapsWidth = (SINGLE_MAP_COLS * currentTileSize + mapBorderWidth) * NUM_MAPS_ACROSS;
            const totalGapsWidth = (NUM_MAPS_ACROSS - 1) * gapBetweenMaps;
            mapsSuperContainer.style.minWidth = `${totalMapsWidth + totalGapsWidth}px`;


            gridDimensionsDisplay.textContent = `${SINGLE_MAP_COLS}x${SINGLE_MAP_ROWS} (per map)`;

            placedItems.forEach(item => {
                if (item.element) {
                    item.element.style.left = `${item.x * currentTileSize}px`;
                    item.element.style.top = `${item.y * currentTileSize}px`;
                    item.element.style.width = `${item.width * currentTileSize}px`;
                    item.element.style.height = `${item.height * currentTileSize}px`;
                }
            });
        }

        // --- ITEM PLACEMENT FUNCTIONS ---
        function addPlacedItemToGrid(mapId, itemData, gridX, gridY) {
            const uniqueId = nextPlacedItemId++;
            const newItem = {
                id: uniqueId, mapId: mapId, x: gridX, y: gridY,
                width: itemData.width, height: itemData.height,
                itemId: itemData.itemId, name: itemData.name,
                imageSrc: itemData.imageSrc, allianceName: selectedAllianceName,
            };

            const itemElement = document.createElement('div');
            itemElement.classList.add('placed-item-on-grid');
            itemElement.style.left = `${newItem.x * currentTileSize}px`;
            itemElement.style.top = `${newItem.y * currentTileSize}px`;
            itemElement.style.width = `${newItem.width * currentTileSize}px`;
            itemElement.style.height = `${newItem.height * currentTileSize}px`;

            const img = document.createElement('img');
            img.src = newItem.imageSrc;
            img.alt = newItem.name; // Alt text for accessibility
            img.onerror = function() { // Handle broken image links
                this.style.display = 'none'; // Hide broken image icon
                itemElement.style.backgroundColor = 'lightcoral'; // Indicate error
                const errorText = document.createElement('span');
                errorText.textContent = `Err: ${newItem.name}`;
                errorText.style.color = 'white';
                errorText.style.fontSize = '0.8em';
                itemElement.appendChild(errorText);
                console.warn(`Image not loaded: ${newItem.imageSrc} for item ${newItem.name}`);
            };
            itemElement.appendChild(img);

            const textOverlay = document.createElement('div');
            textOverlay.classList.add('placed-item-text-overlay');
            let overlayTextContent = `${newItem.name}`;
            if(newItem.allianceName && newItem.allianceName !== "Neutral") {
                overlayTextContent += ` (${newItem.allianceName})`;
            }
            textOverlay.textContent = overlayTextContent;
            itemElement.appendChild(textOverlay);

            itemElement.title = `Click to remove: ${newItem.name}${newItem.allianceName && newItem.allianceName !== "Neutral" ? ' (' + newItem.allianceName + ')' : ''}`;
            itemElement.dataset.placedId = uniqueId;

            itemElement.addEventListener('click', (event) => {
                event.stopPropagation();
                removePlacedItem(uniqueId);
            });

            newItem.element = itemElement;
            placedItems.push(newItem);

            const targetMapElement = mapElements[mapId];
            if (targetMapElement) {
                targetMapElement.appendChild(itemElement);
            } else {
                console.error("Target map element not found for mapId:", mapId);
            }
        }

        function removePlacedItem(placedId) {
            const itemIndex = placedItems.findIndex(p => p.id === placedId);
            if (itemIndex > -1) {
                const itemToRemove = placedItems[itemIndex];
                if (itemToRemove.element && itemToRemove.element.parentNode) {
                    itemToRemove.element.parentNode.removeChild(itemToRemove.element);
                }
                placedItems.splice(itemIndex, 1);
            }
        }

        // --- DRAG AND DROP HANDLERS ---
        buildableItemsList.forEach(item => {
            item.addEventListener('dragstart', (event) => {
                const target = event.currentTarget;
                draggedItemData = {
                    itemId: target.dataset.itemId,
                    width: parseInt(target.dataset.width),
                    height: parseInt(target.dataset.height),
                    name: target.dataset.name,
                    imageSrc: target.dataset.imageSrc,
                    offsetX: event.offsetX, offsetY: event.offsetY
                };
                target.style.opacity = '0.5';
            });
            item.addEventListener('dragend', (event) => {
                event.currentTarget.style.opacity = '1';
                draggedItemData = null;
            });
        });

        function handleMapDragOver(event) {
            event.preventDefault();
        }

        function handleMapDrop(event) {
            event.preventDefault();
            if (!draggedItemData) return;

            const targetMapElement = event.currentTarget;
            const mapId = parseInt(targetMapElement.dataset.mapId);
            const mapRect = targetMapElement.getBoundingClientRect();
            const dropX = event.clientX - mapRect.left;
            const dropY = event.clientY - mapRect.top;
            const gridCellX = Math.floor(dropX / currentTileSize);
            const gridCellY = Math.floor(dropY / currentTileSize);

            if (gridCellX < 0 || gridCellY < 0 ||
                gridCellX + draggedItemData.width > SINGLE_MAP_COLS ||
                gridCellY + draggedItemData.height > SINGLE_MAP_ROWS) {
                alert('Item cannot be placed out of bounds of this map.'); return;
            }

            let collision = false;
            for (const existingItem of placedItems) {
                if (existingItem.mapId === mapId) {
                    if (gridCellX < existingItem.x + existingItem.width &&
                        gridCellX + draggedItemData.width > existingItem.x &&
                        gridCellY < existingItem.y + existingItem.height &&
                        gridCellY + draggedItemData.height > existingItem.y) {
                        collision = true; break;
                    }
                }
            }
            if (collision) {
                alert('Cannot place item here, it overlaps with another item on this map.'); return;
            }
            addPlacedItemToGrid(mapId, draggedItemData, gridCellX, gridCellY);
            draggedItemData = null;
        }

        // --- ALLIANCE FUNCTIONS ---
        function renderAllianceList() {
            allianceListUl.innerHTML = '';
            alliances.forEach(name => {
                const li = document.createElement('li');
                const nameSpan = document.createElement('span');
                nameSpan.textContent = name;
                li.appendChild(nameSpan);
                if (name === selectedAllianceName) li.classList.add('selected');

                li.addEventListener('click', (e) => {
                    if (e.target.classList.contains('delete-alliance-btn')) return;
                    selectedAllianceName = name;
                    currentAllianceDisplay.textContent = selectedAllianceName;
                    renderAllianceList();
                });

                if (name !== "Neutral") {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '×';
                    deleteBtn.classList.add('delete-alliance-btn');
                    deleteBtn.title = `Delete alliance: ${name}`;
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (confirm(`Are you sure you want to delete "${name}"? Items will become "Neutral".`)) {
                            deleteAlliance(name);
                        }
                    });
                    li.appendChild(deleteBtn);
                }
                allianceListUl.appendChild(li);
            });
        }

        function deleteAlliance(nameToDelete) {
            alliances = alliances.filter(name => name !== nameToDelete);
            placedItems.forEach(item => {
                if (item.allianceName === nameToDelete) {
                    item.allianceName = "Neutral";
                    if (item.element) {
                        const textOverlay = item.element.querySelector('.placed-item-text-overlay');
                        if (textOverlay) textOverlay.textContent = `${item.name}`;
                        item.element.title = `Click to remove: ${item.name}`;
                    }
                }
            });
            if (selectedAllianceName === nameToDelete) {
                selectedAllianceName = "Neutral";
                currentAllianceDisplay.textContent = selectedAllianceName;
            }
            renderAllianceList();
        }

        addAllianceBtn.addEventListener('click', () => {
            const name = newAllianceNameInput.value.trim();
            if (name && !alliances.includes(name)) {
                alliances.push(name);
                newAllianceNameInput.value = '';
                renderAllianceList();
            } else if (!name) alert("Please enter an alliance name.");
            else alert("Alliance name already exists.");
        });
        newAllianceNameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addAllianceBtn.click(); });

        // --- TOOLBAR EVENT LISTENERS ---
        tileSizeSlider.addEventListener('input', (event) => {
            currentTileSize = parseInt(event.target.value);
            tileSizeValueDisplay.textContent = `${currentTileSize}px`;
            updateGridAppearance();
        });

        clearAllBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to clear all items from ALL maps?')) {
                placedItems.forEach(item => {
                    if (item.element && item.element.parentNode) {
                        item.element.parentNode.removeChild(item.element);
                    }
                });
                placedItems = [];
                nextPlacedItemId = 0;
            }
        });

        // --- INITIALIZATION ---
        function init() {
            createMapContainers();
            currentAllianceDisplay.textContent = selectedAllianceName;
            renderAllianceList();
        }

        init();
    </script>
</body>
</html>
